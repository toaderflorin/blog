{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2022-02-26-js-closures/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"49d07fff-b936-56c4-908d-a27b601cf0b7","excerpt":"Closures are probably one of the most unintuitive features for newcomers to Javascript, especially if they come from languages such as Java or C#. The notion of…","html":"<p>Closures are probably one of the most unintuitive features for newcomers to Javascript, especially if they come from languages such as Java or C#. The notion of a function within another function itself isn’t hard to understand, the significant hurdle in understanding comes with preserving the lexical environment around these functions once the parent function has finished executing. There are also quite a few articles that use misleading terminology — for example, context versus execution context, lexical environment versus scope, etc. We’ll aim to clarify the terms.</p>\n<p><em>An important concept to mention is that functions are first-class citizens in Javascript, whereas in C# / Java, it’s the classes that are first-class citizens. So even though a language like C# does support closures, they use some magic under the hood, as we’ll explain later.</em></p>\n<h3>Scope</h3>\n<p>Let’s look at what <em>scope</em> means first. Scoping simply means reducing the visibility of variables based on the block where they have been declared. The JS engine recognizes three types of scopes:</p>\n<ol>\n<li>The global scope.</li>\n<li>Function scopes.</li>\n<li>Block scopes.</li>\n</ol>\n<p>We can consider the following piece of code:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> arrayItems <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">logArrayItems</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> item <span class=\"token keyword\">of</span> arrayItems<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> message <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Array item </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>i<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> is </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>item<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>message<span class=\"token punctuation\">)</span>\n    i<span class=\"token operator\">++</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">logArrayItems</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This is how it looks like:</p>\n<img src=\"stack.svg\" class=\"img\" />\n<p>In this case, the global scope contains <em>arrayItems</em>, <em>i</em> is in the function scope and <em>message</em> is in the block scope. So far, this is intuitive, and it’s not that much different than what we would expect from a language like C#, Java, or C.</p>\n<p>Scopes form a chain. Variable resolution works as follows: if a variable isn’t available in the current scope, it goes up the chain.</p>\n<h3>Execution context</h3>\n<p>The term <em>context</em> refers to what the <em>this</em> keyword points to, which is different from <em>execution context</em>, as we will see in a moment. Since JS is not an OOP imperative language (classes are just syntactic sugar), the value of the <em>this</em> keyword depends on how the function is called (see <em>bind</em> or <em>apply</em>), but explaining it is beyond the scope of this article.  The <em>execution context</em> is a general abstract term and refers to several things taken as a whole:</p>\n<ul>\n<li>The value of <em>this</em>.</li>\n<li>The lexical environment in which the code runs in — in the case of functions, that’s the outer scope.</li>\n<li>The code/function’s own variables.</li>\n</ul>\n<p>When the JS engine starts a script, it creates something which is called a <em>global execution context</em>. Each execution context has two phases:</p>\n<ol>\n<li>The creation phase.</li>\n<li>The execution phase.</li>\n</ol>\n<p>Javascript also introduces a concept called “hoisting”. This refers to variables being available before being declared, but contrary to what the term would intuitively suggest, nothing is actually being hoisted. Instead, what happens is the JS engine first does a pass through the code and determines which variables are declared and assigns an undefined value for them. The term “hoisting” comes from the illusion this gives that the declaration has been moved to the beginning of the block.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">showXandY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'x is '</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'y is '</span><span class=\"token punctuation\">,</span> y<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">showXandY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// we get undefined and undefined</span>\n\n<span class=\"token keyword\">const</span> x <span class=\"token operator\">=</span> <span class=\"token number\">12</span>\n<span class=\"token keyword\">const</span> y <span class=\"token operator\">=</span> <span class=\"token number\">14</span>\n\n<span class=\"token function\">showXandY</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// here, we get 12 and 14</span></code></pre></div>\n<p>Also we have:</p>\n<ol>\n<li>A global execution context.</li>\n<li>A function execution context.</li>\n</ol>\n<p><em><b>Remember:</b> scope refers to the visibility of the variables, and context refers to where the code is executed.</em></p>\n<h3>Closures</h3>\n<p>Let’s look at a more complicated example:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> name <span class=\"token operator\">=</span> <span class=\"token string\">'global variable'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">f1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createClosure</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>    \n  <span class=\"token keyword\">function</span> <span class=\"token function\">f2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'starting...'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">f1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">f2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> g1 <span class=\"token operator\">=</span> <span class=\"token function\">createClosure</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> g2 <span class=\"token operator\">=</span> <span class=\"token function\">createClosure</span><span class=\"token punctuation\">(</span><span class=\"token string\">'b'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token function\">c1</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">c2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>This seriously complicates things. First, we can see we can see thate <em>createClosure</em> returns another function — so they really are objects. We create two instances, <em>g1</em> and <em>g2</em>. The first question would be which <em>name</em> variable the <em>f1</em> function “sees”, because it’s being run from <em>createClosure</em>, but it’s being declared outside. The answer is it seems the variable in the global scope.</p>\n<p>If we run this, we get:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">starting...\nouter variable\na\nstarting...\nouter variable\nb</code></pre></div>\n<p>What’s interesting is that <em>f2</em> is able to display the value of the name parameter even though the <em>createClosure</em> function has finished executing. This aspect captures what closures are all about.</p>\n<p>If a function returns a value that is another function (functions are objects), the JS engine creates a “closure” around it and preserves the returned function’s lexical environment that the inner function lives in at the moment it was created. This has several potential uses and also side-effects — a simple side effect is the one mentioned before — since React components are closures, they keep the value of <em>state</em> at the moment the function was called (it acts as a render function), you cannot use a global state object per component and you cannot merge new partial state asynchroniously because other actions might have changed the state in the meantime. A simple example of closure can be the result returned by a React higher order component.</p>\n<h3>Closures For Private Fields</h3>\n<p>Closures are also interesting because they can be used to emulate private class data. While there are classes in JS, they are simply syntactical sugar over prototypical inheritance, and you can’t have private fields. Normally most developers wouldn’t need to know how closures work, but given how popular React’s functional components are (which make use of closures) and the amount of frustration not understanding them, a guide to explain them in detail is needed. With the advent of TypeScript however, we don’t need to do this.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">Person</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">firstName<span class=\"token punctuation\">,</span> lastName<span class=\"token punctuation\">,</span> age</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> _age <span class=\"token operator\">=</span> age\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">incrementAge</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    _age <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n  <span class=\"token punctuation\">}</span> \n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">showStats</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>firstName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>lastName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">, age </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>_age<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    incrementAge<span class=\"token punctuation\">,</span>\n    showStats\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> person1 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Person</span><span class=\"token punctuation\">(</span><span class=\"token string\">'John'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Doe'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">32</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> person2 <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Person</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Jane'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'Doe'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">24</span><span class=\"token punctuation\">)</span>\n\nconsole<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>person1<span class=\"token punctuation\">.</span>incrementAge <span class=\"token operator\">===</span> person2<span class=\"token punctuation\">.</span>incrementAge<span class=\"token punctuation\">)</span> <span class=\"token comment\">// false</span></code></pre></div>\n<p>Let’s try to unpack what happens here. The methods <em>incrementAge</em> and <em>showStats</em> live inside the <em>Person</em> function scope. They “see” <em>firstName</em>, <em>lastName</em>, <em>age</em> and <em>_age</em> (which acts as a private variable). They constitute the lexical environment for these functions. When the outer function returns an object referencing these functions (and again keep in mind they are simply objects).</p>\n<h3>A Look At C# Closures</h3>\n<p>To illustrate how remarkable closures are, it’s worth pointing out what the .NET runtime does to support them (they are only supported from C# 7.0 and up).</p>\n<p>With C# / VB.NET in general, there has been a move towards a hybrid imperative/functional language, so support for “functions in functions” wasn’t unexpected. And, of course, scoping requires closures — so let’s look at how .NET achieves them.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token class-name\"><span class=\"token keyword\">int</span></span> a <span class=\"token operator\">=</span> <span class=\"token number\">10</span><span class=\"token punctuation\">;</span>\n<span class=\"token class-name\">Action</span> del <span class=\"token operator\">=</span> <span class=\"token keyword\">delegate</span> \n<span class=\"token punctuation\">{</span> \n  Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token interpolation-string\"><span class=\"token string\">$\"a is </span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token expression language-csharp\">x</span><span class=\"token punctuation\">}</span></span><span class=\"token string\">.\"</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> \n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">del</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>C# uses the concept of a “delegate” to refer function objects that can be passed around - they are essentially reference types. The problem with delegates is that they don’t have any state, so when the C# compiler detects a delegate that forms a closure returned to the outside scope, the function and its associated local variables are promoted to a compiler-generated class. The compiler then treats the delegate as a method in this class.</p>\n<div class=\"gatsby-highlight\" data-language=\"csharp\"><pre class=\"language-csharp\"><code class=\"language-csharp\"><span class=\"token punctuation\">[</span><span class=\"token attribute\"><span class=\"token class-name\">CompilerGenerated</span></span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">private</span> <span class=\"token keyword\">sealed</span> <span class=\"token keyword\">class</span> <span class=\"token operator\">&lt;</span><span class=\"token operator\">></span>c__DisplayClass0_0\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">public</span> <span class=\"token class-name\"><span class=\"token keyword\">int</span></span> a<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">internal</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">&lt;</span>M<span class=\"token operator\">></span><span class=\"token function\">b__0</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        Console<span class=\"token punctuation\">.</span><span class=\"token function\">WriteLine</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">string</span><span class=\"token punctuation\">.</span><span class=\"token function\">Format</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"a is {0}.\"</span><span class=\"token punctuation\">,</span> x<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As we can see from the .NET implementation, we really just have a function with some data.</p>","frontmatter":{"title":"Execution Contexts, Scopes and Closures","date":"February 26, 2022","description":"Closures are probably one of the most unintuitive features for newcomers to Javascript, especially if they come from languages such as Java or C#. The notion of a function within another function itself isn't hard to understand, the significant hurdle in understanding comes with preserving the lexical environment around these functions once the parent function has finished executing. There are also quite a few articles that use misleading terminology -- for example, context versus execution context, lexical environment versus scope, etc. We'll aim to clarify the terms.  "}},"previous":{"fields":{"slug":"/2022-04-30-big-ball-of-mud/"},"frontmatter":{"title":"Modern Big Balls Of Mud"}},"next":{"fields":{"slug":"/2022-04-30-big-ball-of-mud/"},"frontmatter":{"title":"Modern Big Balls Of Mud"}}},"pageContext":{"id":"49d07fff-b936-56c4-908d-a27b601cf0b7"}},
    "staticQueryHashes": []}