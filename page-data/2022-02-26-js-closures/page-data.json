{"componentChunkName":"component---src-templates-blog-post-js","path":"/2022-02-26-js-closures/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"a304ddea-6664-5885-a31a-fcbfb0436055","excerpt":"Closures are probably one of the most unintuitive features for newcomers to Javascript, especially if they come from languages such as Java or C#. The notion of…","html":"<p>Closures are probably one of the most unintuitive features for newcomers to Javascript, especially if they come from languages such as Java or C#. The notion of a function within another function itself isn’t hard to understand, the significant hurdle in understanding comes with preserving the lexical environment around these functions once the parent function has finished executing. There are also quite a few articles that use misleading terminology — for example, context versus execution context, lexical environment versus scope, etc. We’ll aim to clarify the terms.</p>\n<p><em>An important concept to mention is that functions are first-class citizens in Javascript, whereas in C# / Java, it’s the classes that are first-class citizens. So even though a language like C# does support closures, they use some magic under the hood, as we’ll explain later.</em></p>\n<h3>Scope</h3>\n<p>Let’s look at what <em>scope</em> means first. Scoping simply means reducing the visibility of variables based on the block where they have been declared. The JS engine recognizes three types of scopes:</p>\n<ol>\n<li>The global scope.</li>\n<li>Function scopes.</li>\n<li>Block scopes.</li>\n</ol>\n<p>We can consider the following piece of code:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">arrayItems</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> [</span><span style=\"color: #0550AE\">1</span><span style=\"color: #24292F\">, </span><span style=\"color: #0550AE\">2</span><span style=\"color: #24292F\">, </span><span style=\"color: #0550AE\">3</span><span style=\"color: #24292F\">, </span><span style=\"color: #0550AE\">4</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">logArrayItems</span><span style=\"color: #24292F\">() {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">let</span><span style=\"color: #24292F\"> i </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">0</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">for</span><span style=\"color: #24292F\"> (</span><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">item</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">of</span><span style=\"color: #24292F\"> arrayItems) {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">message</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">`Array item ${</span><span style=\"color: #24292F\">i</span><span style=\"color: #0A3069\">} is ${</span><span style=\"color: #24292F\">item</span><span style=\"color: #0A3069\">}`</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    console.</span><span style=\"color: #8250DF\">log</span><span style=\"color: #24292F\">(message)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    i</span><span style=\"color: #CF222E\">++</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #8250DF\">logArrayItems</span><span style=\"color: #24292F\">()</span></span></code></pre>\n<p>This is how it looks like:</p>\n<img src=\"stack.svg\" class=\"img\" />\n<p>In this case, the global scope contains <em>arrayItems</em>, <em>i</em> is in the function scope and <em>message</em> is in the block scope. So far, this is intuitive, and it’s not that much different than what we would expect from a language like C#, Java, or C.</p>\n<p>Scopes form a chain. Variable resolution works as follows: if a variable isn’t available in the current scope, it goes up the chain.</p>\n<h3>Execution context</h3>\n<p>The term <em>context</em> refers to what the <em>this</em> keyword points to, which is different from <em>execution context</em>, as we will see in a moment. Since JS is not an OOP imperative language (classes are just syntactic sugar), the value of the <em>this</em> keyword depends on how the function is called (see <em>bind</em> or <em>apply</em>), but explaining it is beyond the scope of this article.  The <em>execution context</em> is a general abstract term and refers to several things taken as a whole:</p>\n<ul>\n<li>The value of <em>this</em>.</li>\n<li>The lexical environment in which the code runs in — in the case of functions, that’s the outer scope.</li>\n<li>The code/function’s own variables.</li>\n</ul>\n<p>When the JS engine starts a script, it creates something which is called a <em>global execution context</em>. Each execution context has two phases:</p>\n<ol>\n<li>The creation phase.</li>\n<li>The execution phase.</li>\n</ol>\n<p>Javascript also introduces a concept called “hoisting”. This refers to variables being available before being declared, but contrary to what the term would intuitively suggest, nothing is actually being hoisted. Instead, what happens is the JS engine first does a pass through the code and determines which variables are declared and assigns an undefined value for them. The term “hoisting” comes from the illusion this gives that the declaration has been moved to the beginning of the block.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">showXandY</span><span style=\"color: #24292F\">() {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  console.</span><span style=\"color: #8250DF\">log</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;x is &#39;</span><span style=\"color: #24292F\">, x)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  console.</span><span style=\"color: #8250DF\">log</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;y is &#39;</span><span style=\"color: #24292F\">, y)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #8250DF\">showXandY</span><span style=\"color: #24292F\">() </span><span style=\"color: #6E7781\">// we get undefined and undefined</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">x</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">12</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">y</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">14</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #8250DF\">showXandY</span><span style=\"color: #24292F\">() </span><span style=\"color: #6E7781\">// here, we get 12 and 14</span></span></code></pre>\n<p>Also we have:</p>\n<ol>\n<li>A global execution context.</li>\n<li>A function execution context.</li>\n</ol>\n<p><em><b>Remember:</b> scope refers to the visibility of the variables, and context refers to where the code is executed.</em></p>\n<h3>Closures</h3>\n<p>Let’s look at a more complicated example:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #CF222E\">let</span><span style=\"color: #24292F\"> name </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">&#39;global variable&#39;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">f1</span><span style=\"color: #24292F\">() {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  console.</span><span style=\"color: #8250DF\">log</span><span style=\"color: #24292F\">(name)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">createClosure</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">name</span><span style=\"color: #24292F\">) {    </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">f2</span><span style=\"color: #24292F\">() {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    console.</span><span style=\"color: #8250DF\">log</span><span style=\"color: #24292F\">(name)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">return</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\">() {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    console.</span><span style=\"color: #8250DF\">log</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;starting...&#39;</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #8250DF\">f1</span><span style=\"color: #24292F\">()</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #8250DF\">f2</span><span style=\"color: #24292F\">()</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">g1</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">createClosure</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;a&#39;</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">g2</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">createClosure</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;b&#39;</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #8250DF\">c1</span><span style=\"color: #24292F\">()</span></span>\n<span class=\"line\"><span style=\"color: #8250DF\">c2</span><span style=\"color: #24292F\">()</span></span></code></pre>\n<p>This seriously complicates things. First, we can see we can see thate <em>createClosure</em> returns another function — so they really are objects. We create two instances, <em>g1</em> and <em>g2</em>. The first question would be which <em>name</em> variable the <em>f1</em> function “sees”, because it’s being run from <em>createClosure</em>, but it’s being declared outside. The answer is it seems the variable in the global scope.</p>\n<p>If we run this, we get:</p>\n<pre class=\"shiki-unknown\"><code>starting...\nouter variable\na\nstarting...\nouter variable\nb</code></pre>\n<p>What’s interesting is that <em>f2</em> is able to display the value of the name parameter even though the <em>createClosure</em> function has finished executing. This aspect captures what closures are all about.</p>\n<p>If a function returns a value that is another function (functions are objects), the JS engine creates a “closure” around it and preserves the returned function’s lexical environment that the inner function lives in at the moment it was created. This has several potential uses and also side-effects — a simple side effect is the one mentioned before — since React components are closures, they keep the value of <em>state</em> at the moment the function was called (it acts as a render function), you cannot use a global state object per component and you cannot merge new partial state asynchroniously because other actions might have changed the state in the meantime. A simple example of closure can be the result returned by a React higher order component.</p>\n<h3>Closures For Private Fields</h3>\n<p>Closures are also interesting because they can be used to emulate private class data. While there are classes in JS, they are simply syntactical sugar over prototypical inheritance, and you can’t have private fields. Normally most developers wouldn’t need to know how closures work, but given how popular React’s functional components are (which make use of closures) and the amount of frustration not understanding them, a guide to explain them in detail is needed. With the advent of TypeScript however, we don’t need to do this.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">Person</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">firstName</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">lastName</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">age</span><span style=\"color: #24292F\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">let</span><span style=\"color: #24292F\"> _age </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> age</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">incrementAge</span><span style=\"color: #24292F\">() {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    _age </span><span style=\"color: #CF222E\">+=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">1</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  } </span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">showStats</span><span style=\"color: #24292F\">() {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">return</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">`${</span><span style=\"color: #24292F\">firstName</span><span style=\"color: #0A3069\">} ${</span><span style=\"color: #24292F\">lastName</span><span style=\"color: #0A3069\">}, age ${</span><span style=\"color: #24292F\">_age</span><span style=\"color: #0A3069\">}`</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">return</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    incrementAge,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    showStats</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">person1</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">new</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">Person</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;John&#39;</span><span style=\"color: #24292F\">, </span><span style=\"color: #0A3069\">&#39;Doe&#39;</span><span style=\"color: #24292F\">, </span><span style=\"color: #0550AE\">32</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">person2</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">new</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">Person</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;Jane&#39;</span><span style=\"color: #24292F\">, </span><span style=\"color: #0A3069\">&#39;Doe&#39;</span><span style=\"color: #24292F\">, </span><span style=\"color: #0550AE\">24</span><span style=\"color: #24292F\">)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">console.</span><span style=\"color: #8250DF\">log</span><span style=\"color: #24292F\">(person1.incrementAge </span><span style=\"color: #CF222E\">===</span><span style=\"color: #24292F\"> person2.incrementAge) </span><span style=\"color: #6E7781\">// false</span></span></code></pre>\n<p>Let’s try to unpack what happens here. The methods <em>incrementAge</em> and <em>showStats</em> live inside the <em>Person</em> function scope. They “see” <em>firstName</em>, <em>lastName</em>, <em>age</em> and <em>_age</em> (which acts as a private variable). They constitute the lexical environment for these functions. When the outer function returns an object referencing these functions (and again keep in mind they are simply objects).</p>\n<h3>A Look At C# Closures</h3>\n<p>To illustrate how remarkable closures are, it’s worth pointing out what the .NET runtime does to support them (they are only supported from C# 7.0 and up).</p>\n<p>With C# / VB.NET in general, there has been a move towards a hybrid imperative/functional language, so support for “functions in functions” wasn’t unexpected. And, of course, scoping requires closures — so let’s look at how .NET achieves them.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #CF222E\">int</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">a</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">10</span><span style=\"color: #24292F\">;</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">Action</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">del</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">delegate</span><span style=\"color: #24292F\"> </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">{ </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  Console.</span><span style=\"color: #8250DF\">WriteLine</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">$&quot;a is {</span><span style=\"color: #24292F\">x</span><span style=\"color: #0A3069\">}.&quot;</span><span style=\"color: #24292F\">); </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">};</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #8250DF\">del</span><span style=\"color: #24292F\">();</span></span></code></pre>\n<p>C# uses the concept of a “delegate” to refer function objects that can be passed around - they are essentially reference types. The problem with delegates is that they don’t have any state, so when the C# compiler detects a delegate that forms a closure returned to the outside scope, the function and its associated local variables are promoted to a compiler-generated class. The compiler then treats the delegate as a method in this class.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #24292F\">[</span><span style=\"color: #CF222E\">CompilerGenerated</span><span style=\"color: #24292F\">]</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">private</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">sealed</span><span style=\"color: #24292F\"> class &lt;&gt;c__DisplayClass0_0</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">{</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">public</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">int</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">a</span><span style=\"color: #24292F\">;</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">internal</span><span style=\"color: #24292F\"> void &lt;M&gt;</span><span style=\"color: #8250DF\">b__0</span><span style=\"color: #24292F\">()</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        Console.</span><span style=\"color: #8250DF\">WriteLine</span><span style=\"color: #24292F\">(string.</span><span style=\"color: #8250DF\">Format</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&quot;a is {0}.&quot;</span><span style=\"color: #24292F\">, x));</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>As we can see from the .NET implementation, we really just have a function with some data.</p>","frontmatter":{"title":"Execution Contexts, Scopes and Closures","date":"February 26, 2022","description":"Closures are probably one of the most unintuitive features for newcomers to Javascript, especially if they come from languages such as Java or C#. The notion of a function within another function itself isn't hard to understand, the significant hurdle in understanding comes with preserving the lexical environment around these functions once the parent function has finished executing. There are also quite a few articles that use misleading terminology -- for example, context versus execution context, lexical environment versus scope, etc. We'll aim to clarify the terms.  "}},"previous":{"fields":{"slug":"/2022-05-30-estimations/"},"frontmatter":{"title":"Why It's So Hard To Get Estimations Right?"}},"next":{"fields":{"slug":"/2022-05-30-estimations/"},"frontmatter":{"title":"Why It's So Hard To Get Estimations Right?"}}},"pageContext":{"id":"a304ddea-6664-5885-a31a-fcbfb0436055"}},"staticQueryHashes":[]}