{"componentChunkName":"component---src-templates-blog-post-js","path":"/2021-11-05-immutability/","result":{"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"e1b1a157-ae0c-56dd-b7b1-b3535f667b7e","excerpt":"Before getting into library-specific details, it’s worth starting with a definition of what constitutes reactivity. A typical example would be an Excel…","html":"<p>Before getting into library-specific details, it’s worth starting with a definition of what constitutes reactivity. A typical example would be an Excel spreadsheet: if a cell aggregates data from other cells, that cell instantly changes if we change a value in any of the aggregated cells. In reactive programming, if a variable A depends on B and C, a change in either B or C would also trigger a change in A. While there seems to be an ongoing debate whether React is truly reactive, there’s no doubt that the UI reacts to changes in the data model, even if parts of the model itself don’t react to other parts being changed, so from now on, we’ll consider this definition of reactivity.</p>\n<p>Since in most programming languages mutating an existing instance doesn’t notify other objects or the runtime of the change, a typical pattern is to use events or callbacks for this. As an example, Windows Presentation Foundation uses models that implement an interface called\n<span class=\"code\">INotifyPropertyChanged</span> for data-binding and wraps class fields in getters and setters, and it’s the setter’s responsibility to fire change events. .NET provides a convenient base class object that implements the interface, so a typical observable view model would look like this:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #24292F\">public </span><span style=\"color: #CF222E\">class</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ObservableViewModel</span><span style=\"color: #24292F\">: </span><span style=\"color: #953800\">ObservableObject</span><span style=\"color: #24292F\"> </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">{</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">get</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">Field1</span><span style=\"color: #24292F\"> </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    _field1 </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> value;</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #8250DF\">NotifyPropertChanged</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;field1&#39;</span><span style=\"color: #24292F\">);</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #953800\">set</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">return</span><span style=\"color: #24292F\"> _field1;</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>The WPF rendering system receives these events and then uses .NET’s reflection system to read the properties that are named like that. So if you are passing a different string in the notify event, it won’t work.</p>\n<p>VueJS does something similar, but it’s a little bit less transparent; it looks at the model the component was initialized with and then wraps the existing fields in getters and setters that also notify it. These wrappers aren’t directly visible to the user, which is why it is crucial to understand what the library does under the hood — adding a property to the model that wasn’t present when the component was initialized means that property isn’t observable.</p>\n<p>From the Vue docs:</p>\n<img src=\"vue-reactivity.png\" class=\"img\" />\n<p>Mutations play a central role when it comes to observability in these libraries, but React works a little bit differently because it is much more functional in nature. Rendering here is done by calling the setState method on a component, or the component receives new props from a parent. Of course, changing the whole thing is simple because react does a diff. But by using a little functional trick called <em>immutability</em> in our code, we avoid even this diffing process.</p>\n<p>Let us use the customary task manager example and look at the following code:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">taskA</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  id: </span><span style=\"color: #0A3069\">&#39;4b390f82-8b6f-4176-b28e-455ce9c24150&#39;</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  text: </span><span style=\"color: #0A3069\">&#39;Send email to John.&#39;</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  completed: </span><span style=\"color: #0550AE\">false</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">taskB</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  id: </span><span style=\"color: #0A3069\">&#39;32557639-ca7a-4188-868a-2b5938d2bd01&#39;</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  text: </span><span style=\"color: #0A3069\">&#39;Play foosball.&#39;</span><span style=\"color: #24292F\">,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  completed: </span><span style=\"color: #0550AE\">false</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">taskC</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> taskA</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">console.</span><span style=\"color: #8250DF\">log</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;This should be false.&#39;</span><span style=\"color: #24292F\">, taskA </span><span style=\"color: #CF222E\">===</span><span style=\"color: #24292F\"> taskB)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">console.</span><span style=\"color: #8250DF\">log</span><span style=\"color: #24292F\">(</span><span style=\"color: #0A3069\">&#39;This should be true.&#39;</span><span style=\"color: #24292F\">, taskA </span><span style=\"color: #CF222E\">===</span><span style=\"color: #24292F\"> taskC)</span></span></code></pre>\n<p>This of course is nothing new because JavaScript doesn’t check the values of the fields, it checks the instances and in the case of person A and B we have two different instances of an object with fields of equal value.</p>\n<p>Let’s say we now have a method that is called <code>removeLastName()</code>. In the case of mutable languages we could write something like this:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">completeTask</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">task</span><span style=\"color: #24292F\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  task.completed </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">true</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>But functional languages prohibit mutations, and even if JavaSript allows them, if we want to abide by functional principles, we can write it like this instead:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #CF222E\">function</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">completeTask</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">task</span><span style=\"color: #24292F\">) {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">return</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    text: task.text,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    completed: </span><span style=\"color: #0550AE\">true</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>This not only encourages the use of function composition for calculating complicated things, but it also ensures that checking for equality is easy and fast. Since we are never mutating an existing object, checking for value equality reduces to instance equality checking.</p>\n<p>Because of how change notification works in React, immutability is also encouraged because it allows easy diffing of object trees because the comparison algorythm doesn’t have to go drill down recursively, it can simply stop when two fields name the same differ in instance.</p>\n<p>Quite often, beginner React developers write code like this:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #8250DF\">updateTask</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> (</span><span style=\"color: #953800\">id</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">newText</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">completed</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">=&gt;</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">tasks</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">this</span><span style=\"color: #24292F\">.state.tasks</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">existingTask</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> tasks.</span><span style=\"color: #8250DF\">find</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">task</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=&gt;</span><span style=\"color: #24292F\"> task.id </span><span style=\"color: #CF222E\">===</span><span style=\"color: #24292F\"> id)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">if</span><span style=\"color: #24292F\"> (task) {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    existingTask.text </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> newText</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    existingTask.completed </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> lastName</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #0550AE\">this</span><span style=\"color: #24292F\">.</span><span style=\"color: #8250DF\">setState</span><span style=\"color: #24292F\">({</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      tasks</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    })</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>We can do something else insted.</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #8250DF\">updateTask</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> (</span><span style=\"color: #953800\">id</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">text</span><span style=\"color: #24292F\">, </span><span style=\"color: #953800\">completed</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">=&gt;</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">existingTask</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">this</span><span style=\"color: #24292F\">.state.tasks.</span><span style=\"color: #8250DF\">find</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">person</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=&gt;</span><span style=\"color: #24292F\"> person.id </span><span style=\"color: #CF222E\">===</span><span style=\"color: #24292F\"> id)</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">  </span><span style=\"color: #CF222E\">if</span><span style=\"color: #24292F\"> (existingTask) {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">existingTaskIndex</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> persons.</span><span style=\"color: #8250DF\">indexOf</span><span style=\"color: #24292F\">(existingPerson)</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    persons[] </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> firstName</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    existingPerson.lastName </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> lastName</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #0550AE\">this</span><span style=\"color: #24292F\">.</span><span style=\"color: #8250DF\">setState</span><span style=\"color: #24292F\">({</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      persons: [</span><span style=\"color: #CF222E\">...</span><span style=\"color: #24292F\">state.persons, </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    })</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>This ensures updating works.</p>\n<p>Redux is in a some ways similar to the concept of <a href=\"https://reactjs.org/docs/lifting-state-up.html\">lifting state up</a>, but instead of lifting it up to a parent component, we push it to a single shared store. Our fully-fledged todos reducer would look like this:</p>\n<pre class=\"shiki\" style=\"background-color: #ffffff\"><code><span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">ADD_TODO</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">&#39;ADD_TODO&#39;</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">TOGGLE_TODO</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">&#39;TOGGLE_TODO&#39;</span></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #0550AE\">CLEAR_TODOS</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> </span><span style=\"color: #0A3069\">&#39;CLEAR_TODOS&#39;</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #CF222E\">const</span><span style=\"color: #24292F\"> </span><span style=\"color: #8250DF\">todosReducer</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> (</span><span style=\"color: #953800\">state</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=</span><span style=\"color: #24292F\"> [], </span><span style=\"color: #953800\">action</span><span style=\"color: #24292F\">) </span><span style=\"color: #CF222E\">=&gt;</span><span style=\"color: #24292F\"> {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">ADD_TODO</span><span style=\"color: #24292F\">: {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      </span><span style=\"color: #CF222E\">return</span><span style=\"color: #24292F\"> [</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        </span><span style=\"color: #CF222E\">...</span><span style=\"color: #24292F\">state,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">          text: action.text,</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">          completed: </span><span style=\"color: #0550AE\">false</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      ]</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">TOGGLE_TODO</span><span style=\"color: #24292F\">: {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      </span><span style=\"color: #CF222E\">return</span><span style=\"color: #24292F\"> state.</span><span style=\"color: #8250DF\">map</span><span style=\"color: #24292F\">(</span><span style=\"color: #953800\">todo</span><span style=\"color: #24292F\"> </span><span style=\"color: #CF222E\">=&gt;</span><span style=\"color: #24292F\"> </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">        todo.id </span><span style=\"color: #CF222E\">===</span><span style=\"color: #24292F\">  action.id </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">          </span><span style=\"color: #CF222E\">?</span><span style=\"color: #24292F\"> { </span><span style=\"color: #CF222E\">...</span><span style=\"color: #24292F\">todo, { completed: </span><span style=\"color: #CF222E\">!</span><span style=\"color: #24292F\">todo.completed} } </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">          </span><span style=\"color: #CF222E\">:</span><span style=\"color: #24292F\"> todo      </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      })</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">case</span><span style=\"color: #24292F\"> </span><span style=\"color: #953800\">CLEAR_TODOS</span><span style=\"color: #24292F\">: {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      </span><span style=\"color: #CF222E\">return</span><span style=\"color: #24292F\"> []</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    </span><span style=\"color: #CF222E\">default</span><span style=\"color: #24292F\">: {</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">      return state</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">    }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">  }</span></span>\n<span class=\"line\"><span style=\"color: #24292F\">}</span></span></code></pre>\n<p>Instead of calling <code>setState()</code>, we dispatch an action which is received by a reducer which returns a new value for the application state based on the existing state and the action. Just like setState, a reducer typically leaves the existing fields untouched and just overrides what we want to change but the result is a new instance. In case we don’t want to change anything, we should return state instead of <code>{...state}</code>. Instance comparison still works.</p>","frontmatter":{"title":"Reactivity And Immutability In React","date":"November 05, 2021","description":" Before getting into library-specific details, it's worth starting with a definition of what constitutes reactivity. A typical example would be an Excel spreadsheet: if a cell aggregates data from other cells, that cell instantly changes if we change a value in any of the aggregated cells. In reactive programming, if a variable A depends on B and C, a change in either B or C would also trigger a change in A. While there seems to be an ongoing debate whether React is truly reactive, there's no doubt that the UI reacts to changes in the data model, even if parts of the model itself don't react to other parts being changed, so from now on, we'll consider this definition of reactivity. "}},"previous":{"fields":{"slug":"/2022-05-30-estimations/"},"frontmatter":{"title":"Why It's So Hard To Get Estimations Right?"}},"next":{"fields":{"slug":"/2022-05-30-estimations/"},"frontmatter":{"title":"Why It's So Hard To Get Estimations Right?"}}},"pageContext":{"id":"e1b1a157-ae0c-56dd-b7b1-b3535f667b7e"}},"staticQueryHashes":[]}