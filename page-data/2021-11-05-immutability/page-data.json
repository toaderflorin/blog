{
    "componentChunkName": "component---src-templates-blog-post-js",
    "path": "/2021-11-05-immutability/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Gatsby Starter Blog"}},"markdownRemark":{"id":"092a319e-58f1-5809-9412-1b2493c5c5cf","excerpt":"Before getting into library-specific details, it’s worth starting with a definition of what constitutes reactivity. A typical example would be an Excel…","html":"<p>Before getting into library-specific details, it’s worth starting with a definition of what constitutes reactivity. A typical example would be an Excel spreadsheet: if a cell aggregates data from other cells, that cell instantly changes if we change a value in any of the aggregated cells. In reactive programming, if a variable A depends on B and C, a change in either B or C would also trigger a change in A. While there seems to be an ongoing debate whether React is truly reactive, there’s no doubt that the UI reacts to changes in the data model, even if parts of the model itself don’t react to other parts being changed, so from now on, we’ll consider this definition of reactivity.</p>\n<p>Since in most programming languages mutating an existing instance doesn’t notify other objects or the runtime of the change, a typical pattern is to use events or callbacks for this. As an example, Windows Presentation Foundation uses models that implement an interface called\n<span class=\"code\">INotifyPropertyChanged</span> for data-binding and wraps class fields in getters and setters, and it’s the setter’s responsibility to fire change events. .NET provides a convenient base class object that implements the interface, so a typical observable view model would look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">public</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">ObservableViewModel</span><span class=\"token operator\">:</span> ObservableObject \n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">get</span> Field1 \n  <span class=\"token punctuation\">{</span>\n    _field1 <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">NotifyPropertChanged</span><span class=\"token punctuation\">(</span><span class=\"token string\">'field1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  set\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> _field1<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>The WPF rendering system receives these events and then uses .NET’s reflection system to read the properties that are named like that. So if you are passing a different string in the notify event, it won’t work.</p>\n<p>VueJS does something similar, but it’s a little bit less transparent; it looks at the model the component was initialized with and then wraps the existing fields in getters and setters that also notify it. These wrappers aren’t directly visible to the user, which is why it is crucial to understand what the library does under the hood — adding a property to the model that wasn’t present when the component was initialized means that property isn’t observable.</p>\n<p>From the Vue docs:</p>\n<img src=\"vue-reactivity.png\" class=\"img\" />\n<p>Mutations play a central role when it comes to observability in these libraries, but React works a little bit differently because it is much more functional in nature. Rendering here is done by calling the setState method on a component, or the component receives new props from a parent. Of course, changing the whole thing is simple because react does a diff. But by using a little functional trick called <em>immutability</em> in our code, we avoid even this diffing process.</p>\n<p>Let us use the customary task manager example and look at the following code:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> taskA <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> <span class=\"token string\">'4b390f82-8b6f-4176-b28e-455ce9c24150'</span><span class=\"token punctuation\">,</span>\n  text<span class=\"token operator\">:</span> <span class=\"token string\">'Send email to John.'</span><span class=\"token punctuation\">,</span>\n  completed<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> taskB <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  id<span class=\"token operator\">:</span> <span class=\"token string\">'32557639-ca7a-4188-868a-2b5938d2bd01'</span>\n  text<span class=\"token operator\">:</span> <span class=\"token string\">'Play foosball.'</span><span class=\"token punctuation\">,</span>\n  completed<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> taskC <span class=\"token operator\">=</span> taskA\n\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'This should be false.'</span><span class=\"token punctuation\">,</span> taskA <span class=\"token operator\">===</span> taskB<span class=\"token punctuation\">)</span>\n<span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'This should be true.'</span><span class=\"token punctuation\">,</span> taskA <span class=\"token operator\">===</span> taskC<span class=\"token punctuation\">)</span></code></pre></div>\n<p>This of course is nothing new because JavaScript doesn’t check the values of the fields, it checks the instances and in the case of person A and B we have two different instances of an object with fields of equal value.</p>\n<p>Let’s say we now have a method that is called <code class=\"language-text\">removeLastName()</code>. In the case of mutable languages we could write something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">completeTask</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  task<span class=\"token punctuation\">.</span>completed <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>But functional languages prohibit mutations, and even if JavaSript allows them, if we want to abide by functional principles, we can write it like this instead:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">completeTask</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    text<span class=\"token operator\">:</span> task<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span>\n    completed<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This not only encourages the use of function composition for calculating complicated things, but it also ensures that checking for equality is easy and fast. Since we are never mutating an existing object, checking for value equality reduces to instance equality checking.</p>\n<p>Because of how change notification works in React, immutability is also encouraged because it allows easy diffing of object trees because the comparison algorythm doesn’t have to go drill down recursively, it can simply stop when two fields name the same differ in instance.</p>\n<p>Quite often, beginner React developers write code like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function-variable function\">updateTask</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> newText<span class=\"token punctuation\">,</span> completed<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> tasks <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>tasks\n  <span class=\"token keyword\">const</span> existingTask <span class=\"token operator\">=</span> tasks<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>task <span class=\"token operator\">=></span> task<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span>\n  \n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    existingTask<span class=\"token punctuation\">.</span>text <span class=\"token operator\">=</span> newText\n    existingTask<span class=\"token punctuation\">.</span>completed <span class=\"token operator\">=</span> lastName\n\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      tasks\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We can do something else insted.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token function-variable function\">updateTask</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> text<span class=\"token punctuation\">,</span> completed<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> existingTask <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">.</span>tasks<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span>person <span class=\"token operator\">=></span> person<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span> id<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existingTask<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> existingTaskIndex <span class=\"token operator\">=</span> persons<span class=\"token punctuation\">.</span><span class=\"token function\">indexOf</span><span class=\"token punctuation\">(</span>existingPerson<span class=\"token punctuation\">)</span>\n    persons<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> firstName\n    existingPerson<span class=\"token punctuation\">.</span>lastName <span class=\"token operator\">=</span> lastName\n    \n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      persons<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token operator\">...</span>state<span class=\"token punctuation\">.</span>persons<span class=\"token punctuation\">,</span> \n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>This ensures updating works.</p>\n<p>Redux is in a some ways similar to the concept of <a href=\"https://reactjs.org/docs/lifting-state-up.html\">lifting state up</a>, but instead of lifting it up to a parent component, we push it to a single shared store. Our fully-fledged todos reducer would look like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">ADD_TODO</span> <span class=\"token operator\">=</span> <span class=\"token string\">'ADD_TODO'</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">TOGGLE_TODO</span> <span class=\"token operator\">=</span> <span class=\"token string\">'TOGGLE_TODO'</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">CLEAR_TODOS</span> <span class=\"token operator\">=</span> <span class=\"token string\">'CLEAR_TODOS'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">todosReducer</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>state <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> action<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">ADD_TODO</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>\n        <span class=\"token operator\">...</span>state<span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">{</span>\n          text<span class=\"token operator\">:</span> action<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">,</span>\n          completed<span class=\"token operator\">:</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span>\n      <span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">case</span> <span class=\"token constant\">TOGGLE_TODO</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> state<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>todo <span class=\"token operator\">=></span> \n        todo<span class=\"token punctuation\">.</span>id <span class=\"token operator\">===</span>  action<span class=\"token punctuation\">.</span>id \n          <span class=\"token operator\">?</span> <span class=\"token punctuation\">{</span> <span class=\"token operator\">...</span>todo<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> completed<span class=\"token operator\">:</span> <span class=\"token operator\">!</span>todo<span class=\"token punctuation\">.</span>completed<span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span> \n          <span class=\"token operator\">:</span> todo      \n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">case</span> <span class=\"token constant\">CLEAR_TODOS</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span>\n    \n    <span class=\"token keyword\">default</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> state\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Instead of calling <code class=\"language-text\">setState()</code>, we dispatch an action which is received by a reducer which returns a new value for the application state based on the existing state and the action. Just like setState, a reducer typically leaves the existing fields untouched and just overrides what we want to change but the result is a new instance. In case we don’t want to change anything, we should return state instead of <code class=\"language-text\">{...state}</code>. Instance comparison still works.</p>","frontmatter":{"title":"Reactivity And Immutability In React","date":"November 05, 2021","description":" Before getting into library-specific details, it's worth starting with a definition of what constitutes reactivity. A typical example would be an Excel spreadsheet: if a cell aggregates data from other cells, that cell instantly changes if we change a value in any of the aggregated cells. In reactive programming, if a variable A depends on B and C, a change in either B or C would also trigger a change in A. While there seems to be an ongoing debate whether React is truly reactive, there's no doubt that the UI reacts to changes in the data model, even if parts of the model itself don't react to other parts being changed, so from now on, we'll consider this definition of reactivity. "}},"previous":{"fields":{"slug":"/2022-04-09-cap/"},"frontmatter":{"title":"The CAP Theorem Hugely Oversimplifies Things"}},"next":{"fields":{"slug":"/2022-04-09-cap/"},"frontmatter":{"title":"The CAP Theorem Hugely Oversimplifies Things"}}},"pageContext":{"id":"092a319e-58f1-5809-9412-1b2493c5c5cf"}},
    "staticQueryHashes": []}